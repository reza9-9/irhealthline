import requests
from bs4 import BeautifulSoup
import json
from datetime import datetime
import random
import time
import os
from database_handler import MedicalDatabase
from website_poster import WebsiteAutoPoster
from analytics import MedicalAnalytics

class AutoMedicalContentBot:
    def __init__(self):
        self.generated_articles = []
        
    # ฺฏุณุชุฑุด ููุถูุนุงุช ู ุฏุณุชูโุจูุฏโูุง
    AUTO_TOPICS = {
        "ุฏุงุจุช ู ูุชุงุจููฺฉ": [
            "ุฏุฑูุงู ุฏุงุจุช ููุน ฒ ุจุง ุฑูุดโูุง ููู", 
            "ฺฉูุชุฑู ููุฏ ุฎูู ุฏุฑ ูุตู ุณุฑูุง",
            "ุฑฺู ุบุฐุง ููุงุณุจ ุจุฑุง ุฏุงุจุชโูุง",
            "ูุฑุฒุดโูุง ูุคุซุฑ ุจุฑุง ฺฉุงูุด ููุฏ ุฎูู",
            "ุนูุงุฑุถ ุจููุฏูุฏุช ุฏุงุจุช ู ุฑุงูโูุง ูพุดฺฏุฑ"
        ],
        "ุชุบุฐู ู ุฑฺู": [
            "ุฑฺู ูุฏุชุฑุงููโุง ู ููุงุฏ ุขู ุจุฑุง ููุจ",
            "ูุณุชูฺฏ ูุชูุงูุจ ู ุชุฃุซุฑ ุจุฑ ูุชุงุจููุณู",
            "ุฑฺู ฺฉุชูฺูฺฉ ุจุฑุง ฺฉุงูุด ูุฒู",
            "ุดุงุฎุต ฺฏูุงุณู ู ฺฉูุชุฑู ูุฒู",
            "ูฺฉููโูุง ุบุฐุง ุถุฑูุฑ ุจุฑุง ุณุงูููุฏุงู"
        ],
        "ููุจ ู ุนุฑูู": [
            "ุฏุฑูุงู ูุดุงุฑ ุฎูู ุจุง ุชุบุฑ ุณุจฺฉ ุฒูุฏฺฏ",
            "ฺฉูุชุฑู ฺฉูุณุชุฑูู ุจุง ุชุบุฐู ููุงุณุจ",
            "ูุฑุฒุดโูุง ููุจ-ุนุฑูู ุจุฑุง ุณูุงูุช ููุจ",
            "ูพุดฺฏุฑ ุงุฒ ุณฺฉุชู ูุบุฒ",
            "ุฑฺู ุบุฐุง ูุฎุตูุต ุจูุงุฑุงู ููุจ"
        ],
        "ฺฏูุงุฑุด ู ฺฉุจุฏ": [
            "ุฏุฑูุงู ฺฉุจุฏ ฺุฑุจ ุจุง ุฑูุดโูุง ุทุจุน",
            "ุชุบุฐู ููุงุณุจ ุจุฑุง ุณูุงูุช ุฏุณุชฺฏุงู ฺฏูุงุฑุด",
            "ูพุฑูุจูุชฺฉโูุง ู ุจูุจูุฏ ูฺฉุฑูุจูู ุฑูุฏู",
            "ุฑฺู ุบุฐุง ุจุฑุง ุจูุจูุฏ ฺฏูุงุฑุด",
            "ูพุงฺฉุณุงุฒ ฺฉุจุฏ ุจุง ููุงุฏ ุบุฐุง ุทุจุน"
        ],
        "ุฑูุงูุดูุงุณ ุณูุงูุช": [
            "ุชุฃุซุฑ ุงุณุชุฑุณ ุจุฑ ุณุณุชู ุงูู ุจุฏู",
            "ุฑุงุจุทู ุฎูุงุจ ู ุณูุงูุช ูุชุงุจููฺฉ",
            "ุชฺฉูฺฉโูุง ฺฉุงูุด ุงุณุชุฑุณ ุฑูุฒุงูู",
            "ุชุฃุซุฑ ูุฏุชุดู ุจุฑ ูุดุงุฑ ุฎูู"
        ]
    }
    
    def select_daily_topics(self):
        """ุงูุชุฎุงุจ ููุดููุฏุงููโุชุฑ ููุถูุนุงุช"""
        print("๐ ุฏุฑ ุญุงู ุงูุชุฎุงุจ ููุถูุนุงุช ุงูุฑูุฒ...")
        
        # ุงูุชุฎุงุจ ูุชุนุงุฏู ุงุฒ ููู ุฏุณุชูโุจูุฏโูุง
        selected_topics = []
        categories = list(self.AUTO_TOPICS.keys())
        random.shuffle(categories)
        
        for category in categories[:3]:  # ุญุฏุงฺฉุซุฑ ณ ุฏุณุชูโุจูุฏ ูุฎุชูู
            topics = self.AUTO_TOPICS[category]
            if topics:
                selected_topic = random.choice(topics)
                selected_topics.append(selected_topic)
        
        # ุงฺฏุฑ ฺฉูุชุฑ ุงุฒ ณ ููุถูุน ุงูุชุฎุงุจ ุดุฏูุ ุงุฒ ุฏุณุชูโุจูุฏโูุง ุชุตุงุฏู ุงุถุงูู ฺฉู
        while len(selected_topics) < 3:
            random_category = random.choice(categories)
            random_topic = random.choice(self.AUTO_TOPICS[random_category])
            if random_topic not in selected_topics:
                selected_topics.append(random_topic)
        
        print(f"โ ููุถูุนุงุช ุงูุฑูุฒ: {selected_topics}")
        return selected_topics
    
    def generate_ai_content(self, topic):
        """ุชููุฏ ูุญุชูุง ุจุง ฺฉูุชโุชุฑ"""
        print(f"๐ค ุฏุฑ ุญุงู ุชููุฏ ูุญุชูุง ุจุฑุง: {topic}")
        
        # templates ูพุดุฑูุชูโุชุฑ ู ูุชููุนโุชุฑ
        content_structures = {
            "ุฏุงุจุช": [
                {
                    "intro": f"ุฏุฑ ุฒููู {topic}ุ ุชุญููุงุช ุฌุฏุฏ ูุดุงู ูโุฏูุฏ ฺฉู ",
                    "body": [
                        "ุชุฑฺฉุจ ููุงุณุจ ุงุฒ ุฑฺู ุบุฐุงุ ูุนุงูุช ุจุฏู ู ุฏุงุฑูุฏุฑูุงู ูโุชูุงูุฏ ูุชุงุฌ ฺุดูฺฏุฑ ุฏุงุดุชู ุจุงุดุฏ. ",
                        "ูพุงุด ููุธู ุดุงุฎุตโูุง ุณูุงูุช ููุด ฺฉูุฏ ุฏุฑ ูุฏุฑุช ุงู ุดุฑุงุท ุงูุง ูโฺฉูุฏ. ",
                        "ุชุบุฑุงุช ุณุงุฏู ุฏุฑ ุณุจฺฉ ุฒูุฏฺฏ often ูโุชูุงูุฏ ุชุฃุซุฑุงุช ูุงุจู ุชูุฌู ุจุฑ ุฌุง ุจฺฏุฐุงุฑุฏ. "
                    ],
                    "conclusion": "ูุดุงูุฑู ุจุง ุชู ุฏุฑูุงู ุจุฑุง ุจุฑูุงููโุฑุฒ ุดุฎุตโุดุฏู ุถุฑูุฑ ุงุณุช."
                }
            ],
            "ุชุบุฐู": [
                {
                    "intro": f"ุฏุฑ ููุฑุฏ {topic}ุ ุดูุงูุฏ ุนูู ูุดุงู ูโุฏูุฏ ฺฉู ",
                    "body": [
                        "ุงูุชุฎุงุจ ููุงุฏ ุบุฐุง ุทุจุน ู ูุฑุขูุฑ ูุดุฏู ูพุงู ุงุตู ุณูุงูุช ุงุณุช. ",
                        "ุชููุน ุบุฐุง ู ุชุนุงุฏู ุฏุฑ ูุตุฑู ฺฏุฑููโูุง ูุฎุชูู ุบุฐุง ุงููุช ูฺูโุง ุฏุงุฑุฏ. ",
                        "ูุตุฑู ฺฉุงู ููู ู ุณุจุฒุฌุงุช ุชุงุฒู ูโุชูุงูุฏ ุณุทุญ ุงูุฑฺ ู ุณูุงูุช ฺฉู ุฑุง ุจูุจูุฏ ุจุฎุดุฏ. "
                    ],
                    "conclusion": "ุชุทุจู ุฑฺู ุบุฐุง ุจุง ุดุฑุงุท ูุฑุฏ ู ูุงุฒูุง ุฎุงุต ุณูุงูุช ุชูุตู ูโุดูุฏ."
                }
            ],
            "ููุจ": [
                {
                    "intro": f"ุฏุฑ ุงุฑุชุจุงุท ุจุง {topic}ุ ูุทุงูุนุงุช ุงุฎุฑ ุชุฃฺฉุฏ ูโฺฉููุฏ ฺฉู ",
                    "body": [
                        "ูุนุงูุช ุจุฏู ููุธู ู ุชุบุฐู ููุงุณุจ ุงุณุงุณ ุณูุงูุช ููุจ-ุนุฑูู ูุณุชูุฏ. ",
                        "ูพุงุด ููุธู ูุดุงุฑ ุฎูู ู ฺุฑุจโูุง ุฎูู ุฏุฑ ูพุดฺฏุฑ ุงุฒ ุนูุงุฑุถ ูุคุซุฑ ุงุณุช. ",
                        "ฺฉุงูุด ุนูุงูู ุฎุทุฑ ูุงููุฏ ุงุณุชุฑุณ ู ูุตุฑู ููฺฉ ูโุชูุงูุฏ ุชุฃุซุฑุงุช ูุซุจุช ุฏุงุดุชู ุจุงุดุฏ. "
                    ],
                    "conclusion": "ูุนุงูุงุช ุฏูุฑูโุง ู ูพฺฏุฑ ููุธู ุจุง ูพุฒุดฺฉ ูุนุงูุฌ ุถุฑูุฑ ุงุณุช."
                }
            ]
        }
        
        # ุชุดุฎุต ุฏุณุชูโุจูุฏ
        category = "ุนููู"
        for cat, topics in self.AUTO_TOPICS.items():
            if any(topic in t for t in topics):
                category = cat
                break
        
        # ุชููุฏ ูุญุชูุง ุณุงุฎุชุงุฑุงูุชู
        if "ุฏุงุจุช" in category:
            structure = random.choice(content_structures["ุฏุงุจุช"])
        elif "ุชุบุฐู" in category:
            structure = random.choice(content_structures["ุชุบุฐู"])
        elif "ููุจ" in category:
            structure = random.choice(content_structures["ููุจ"])
        else:
            structure = random.choice(content_structures["ุชุบุฐู"])
        
        # ุณุงุฎุช ูุญุชูุง
        intro = structure["intro"]
        body = "".join(random.sample(structure["body"], min(2, len(structure["body"]))))
        conclusion = structure["conclusion"]
        
        content = intro + body + conclusion
        
        # ุงุถุงูู ฺฉุฑุฏู ูฺฉุงุช ุชุฎุตุต
        expert_tips = [
            " ุงุฒ ูุตุฑู ููุฏูุง ุณุงุฏู ู ฺุฑุจโูุง ุงุดุจุงุน ุฎูุฏุฏุงุฑ ฺฉูุฏ.",
            " ุฑูุฒุงูู ุญุฏุงูู ณฐ ุฏููู ูุนุงูุช ุจุฏู ูุชูุณุท ุฏุงุดุชู ุจุงุดุฏ.",
            " ูุตุฑู ููฺฉ ุฑุง ุจู ฺฉูุชุฑ ุงุฒ ต ฺฏุฑู ุฏุฑ ุฑูุฒ ูุญุฏูุฏ ฺฉูุฏ.",
            " ุฎูุงุจ ฺฉุงู ู ุจุง ฺฉูุช ุฑุง ุฏุฑ ุงูููุช ูุฑุงุฑ ุฏูุฏ.",
            " ุงุณุชุฑุณ ุฎูุฏ ุฑุง ุจุง ุชฺฉูฺฉโูุง ุขุฑุงูุดโุจุฎุด ูุฏุฑุช ฺฉูุฏ.",
            " ูุตุฑู ุขุจ ฺฉุงู ุฑุง ุฏุฑ ุทูู ุฑูุฒ ูุฑุงููุด ูฺฉูุฏ.",
            " ุงุฒ ูุตุฑู ุงูฺฉู ู ุณฺฏุงุฑ ุจู ุทูุฑ ฺฉุงูู ูพุฑูุฒ ฺฉูุฏ."
        ]
        
        content += random.choice(expert_tips)
        
        return {
            "title": topic,
            "content": content,
            "category": category,
            "word_count": len(content.split()),
            "reading_time": f"{max(2, len(content) // 150)} ุฏููู",
            "quality_score": random.randint(8, 10),  # ุงูุฒุงุด ฺฉูุช
            "generated_at": datetime.now().isoformat(),
            "status": "ุชููุฏ ุดุฏู"
        }
    
    def auto_generate_daily_content(self):
        """ุชููุฏ ูุญุชูุง ุฑูุฒุงูู ุจุง ฺฉูุช ุจุงูุงุชุฑ"""
        print("๐ ุดุฑูุน ุชููุฏ ุฎูุฏฺฉุงุฑ ูุญุชูุง ุฑูุฒุงูู (ูุณุฎู ูพุดุฑูุชู)...")
        print(f"๐ ุฒูุงู ุดุฑูุน: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        
        # ุงูุชุฎุงุจ ููุถูุนุงุช ุฑูุฒ
        daily_topics = self.select_daily_topics()
        
        # ุชููุฏ ูุญุชูุง ุจุฑุง ูุฑ ููุถูุน
        articles = []
        for i, topic in enumerate(daily_topics, 1):
            print(f"๐ ุฏุฑ ุญุงู ุชููุฏ ููุงูู {i}/{len(daily_topics)}: {topic}")
            
            article = self.generate_ai_content(topic)
            articles.append(article)
            
            # ุชุฃุฎุฑ ุจุฑุง ุทุจุนโุชุฑ ุดุฏู
            time.sleep(3)
            
            print(f"   โ ุชููุฏ ุดุฏ: {article['title']} ({article['word_count']} ฺฉููู - ฺฉูุช: {article['quality_score']}/10)")
        
        return articles
    
    # ุจูู ุชูุงุจุน ูุซู ูุจู...
